{% extends 'base/echoes_base.html' %}
{% block title %}トップページ{% endblock %}
{% block body %}

<h2 class="mb-3">トップページ</h2>

<p class="mb-4">更新時刻：<strong>{{ now|date:"Y-m-d H:i:s" }}</strong></p>

<h3 class="mt-4">現在のステージ状況</h3>
<div class="card mb-4">
  <div class="card-body">
    <h4 class="card-title">{{ progress_info.progress_team.team_name }}</h4>
    <p class="card-text">{{ progress_info.progress_team.team_desc }}</p>
    <p class="card-text">
      リハ開始：{{ progress_info.start_reha|date:"H:i" }} 〜 
      本番：{{ progress_info.progress_team.onstage_time|date:"H:i" }} 〜 
      {{ progress_info.end|date:"H:i" }}<br>
      リハ：{{ progress_info.progress_team.duration_reha }}分 ＋ 本番：{{ progress_info.progress_team.duration_onst }}分 ＝ 
      合計：{{ progress_info.total_minutes }}分
    </p>

    <div class="progress" role="progressbar" aria-label="演奏進行状況" style="height: 26px;">
      <div class="progress-bar {{ progress_info.bar_class }}"
          role="progressbar"
          style="width: {{ progress_info.progress|floatformat:0 }}%;">
        {{ progress_info.progress|floatformat:0 }}%
      </div>
    </div>

  </div>
</div>

<h3 class="mb-3">各場面の受付状況</h3>

<!-- ======== 受付 ======== -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white stage-header">受付</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>段階</th><th>団体名</th><th>定刻</th><th>到着</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>現在</th><td>{{ checkin1_now.team_name }}</td><td>{{ checkin1_now.checkin_pretime_1 }}</td><td>{% if checkin1_now.checkin_postime_1 %}✅{% endif %}</td>
        </tr>
        <tr><th>次</th><td>{{ checkin1_pos.team_name }}</td><td>{{ checkin1_pos.checkin_pretime_1 }}</td><td>{% if checkin1_pos.checkin_postime_1 %}✅{% endif %}</td></tr>
        <tr><th>次々</th><td>{{ checkin1_pos2.team_name }}</td><td>{{ checkin1_pos2.checkin_pretime_1 }}</td><td>{% if checkin1_pos2.checkin_postime_1 %}✅{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ======== 前室 ======== -->
<div class="card mb-4">
  <div class="card-header bg-success text-white stage-header">前室</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>段階</th><th>団体名</th><th>定刻</th><th>到着</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>現在</th><td>{{ checkin2_now.team_name }}</td><td>{{ checkin2_now.checkin_pretime_1 }}</td><td>{% if checkin2_now.checkin_postime_1 %}✅{% endif %}</td>
        </tr>
        <tr><th>次</th><td>{{ checkin2_pos.team_name }}</td><td>{{ checkin2_pos.checkin_pretime_2 }}</td><td>{% if checkin2_pos.checkin_postime_1 %}✅{% endif %}</td></tr>
        <tr><th>次々</th><td>{{ checkin2_pos2.team_name }}</td><td>{{ checkin2_pos2.checkin_pretime_2 }}</td><td>{% if checkin2_pos2.checkin_postime_1 %}✅{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ======== 舞台 ======== -->
<div class="card mb-4">
  <div class="card-header bg-danger text-white stage-header">オンステージ</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>段階</th><th>団体名</th><th>定刻</th><th>到着</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>現在</th><td>{{ onstage_now.team_name }}</td><td>{{ onstage_now.onstage_time }}</td><td>{% if onstage_now.onstage_time_acc %}✅{% endif %}</td>
        </tr>
        <tr><th>次</th><td>{{ onstage_pos.team_name }}</td><td>{{ onstage_pos.onstage_time }}</td><td>{% if onstage_pos.onstage_time_acc %}✅{% endif %}</td></tr>
        <tr><th>次々</th><td>{{ onstage_pos2.team_name }}</td><td>{{ onstage_pos2.onstage_time }}</td><td>{% if onstage_pos2.onstage_time_acc %}✅{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<h3 class="mb-3">データ登録／確認ページ</h3>

<!-- メニュー（スマホは縦、PCは横） -->
<div class="mb-4 d-grid gap-2 d-md-flex">
  <a href="{% url 'website_app:team_initial_reg' %}" class="btn btn-primary btn-lg">初期登録</a>
  <a href="{% url 'website_app:team_list' %}" class="btn btn-secondary btn-lg">団体一覧</a>
  <a href="{% url 'website_app:report_reg' %}" class="btn btn-warning btn-lg">報告入力</a>
  <a href="{% url 'website_app:report_list' %}" class="btn btn-info btn-lg">報告一覧</a>
</div>


<!-- ======== 自動更新（画面を揺らさない） ======== -->
<script>
  setInterval(() => {
    fetch(window.location.href, { cache: "no-store" })
      .then(res => res.text())
      .then(html => {
        document.body.innerHTML = new DOMParser()
          .parseFromString(html, "text/html")
          .querySelector("body").innerHTML;
      });
  }, 10000);

  bar.classList.remove("bg-success", "bg-warning", "bg-danger", "progress-blink");

  if (percent < 60) {
    bar.classList.add("bg-success");
  } else if (percent < 90) {
    bar.classList.add("bg-warning");
  } else {
    bar.classList.add("bg-danger", "progress-blink");  // ✅ ここで点滅追加
  }
</script>

{% endblock %}