{% extends 'base/echoes_base.html' %}
{% block title %}ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸{% endblock %}
{% block body %}

<style>
  .team-card {
    position: relative;
    overflow: hidden;
    border: none;
    border-radius: 12px;
  }

  .team-card img {
    width: 100%;
    height: 240px;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  /* ãƒ›ãƒãƒ¼æ™‚ã«ç”»åƒãŒå°‘ã—ã‚ºãƒ¼ãƒ  */
  .team-card:hover img {
    transform: scale(1.05);
  }

  /* ä¸‹ 1/4 ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  .team-overlay {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 25%;
    background: linear-gradient(to top, rgba(0,0,0,0.65), rgba(0,0,0,0));
    display: flex;
    align-items: flex-end;
    padding: 10px 15px;
  }

  .team-overlay h5 {
    color: white;
    margin: 0;
    font-weight: 600;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6);
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šç”»åƒä¸Šã®é»’ã‚’å°‘ã—å¼±ã‚ã‚‹ */
  :root[data-bs-theme="dark"] .team-overlay {
    background: linear-gradient(to top, rgba(0,0,0,0.45), rgba(0,0,0,0));
  }
</style>

<h2 class="section-title">ã‚¢ãƒŠã‚¦ãƒ³ã‚¹</h2>

<div class="container-fluid py-3">

  {# --- å…¨ä½“å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ --- #}
  <div class="alert alert-primary shadow-sm mb-4" role="alert">
    <h5 class="mb-1 fw-bold">ğŸ“¢ å…¨ä½“ã‚¢ãƒŠã‚¦ãƒ³ã‚¹</h5>
    <div class="mb-2">{{ report.repo_public.repo_cont|linebreaksbr }}</div>

    <div class="small text-muted">
      æŠ•ç¨¿æ—¥ï¼š{{ report.repo_public.created_at|date:"Y-m-d H:i" }} / 
      ç™ºè¨€è€…ï¼š{{ report.repo_public.repo_pter }}
    </div>

  </div>

  {# --- ã‚¹ã‚¿ãƒƒãƒ•é™å®š --- #}
  {% if user.is_authenticated %}
    <div class="alert alert-warning shadow-sm mb-4" role="alert">
      <h5 class="mb-1 fw-bold">ğŸ›  ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘é€£çµ¡</h5>
      <div class="mb-2">{{ report.repo_staff.repo_cont|linebreaksbr }}</div>

      <div class="small text-muted">
        æŠ•ç¨¿æ—¥ï¼š{{ report.repo_staff.created_at|date:"Y-m-d H:i" }} / 
        ç™ºè¨€è€…ï¼š{{ report.repo_staff.repo_pter }}
      </div>
    </div>

    {# --- Tweet ç”¨é€£çµ¡ --- #}
    <div class="alert alert-secondary shadow-sm" role="alert">
      <h6 class="mb-1 fw-bold">ğŸ¦ ã‚¹ã‚¿ãƒƒãƒ•ã¤ã¶ã‚„ã ğŸ™„</h6>
      <div class="mb-2">{{ report.repo_tweet.repo_cont|linebreaksbr }}</div>

      <div class="small text-muted">
        æŠ•ç¨¿æ—¥ï¼š{{ report.repo_tweet.created_at|date:"Y-m-d H:i" }} / 
        ç™ºè¨€è€…ï¼š{{ report.repo_tweet.repo_pter }}
      </div>
    </div>
  {% endif %}

</div>



<h2 class="section-title">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸</h2>

<div class="card mb-4">
  <div class="team-card shadow-sm">
    {% if progress_info.progress_team.file_artpic %}
      <img src="{{ progress_info.progress_team.file_artpic.url }}" alt="{{ progress_info.progress_team.team_name }}">

      <div class="team-overlay">
        <h5>{{ progress_info.progress_team.team_name }}</h5>
      </div>
    {% else %}
      <!-- ç”»åƒãŒãªã„ã¨ãã®è‡ªå‹•ä»£æ›¿ -->
      <div class="p-4 bg-secondary text-white">
        <h5 class="m-0">{{ progress_info.progress_team.team_name }}</h5>
      </div>
    {% endif %}
  </div>

  <div class="card-body">
    <h4 class="card-title {{ progress_info.now_status.co }}">{{ progress_info.now_status.st }}</h4>
    <p class="card-text">
      <p class="mt-2 card-text text-muted"><small>æ›´æ–°æ™‚åˆ»ï¼š{{ now|date:"Y-m-d H:i:s" }}</small></p>
      ãƒªãƒé–‹å§‹ï¼š{{ progress_info.start_reha|date:"H:i" }} ã€œ 
      æœ¬ç•ªï¼š{{ progress_info.progress_team.onstage_time|date:"H:i" }} ã€œ 
      {{ progress_info.end|date:"H:i" }}<br>
      ãƒªãƒï¼š{{ progress_info.progress_team.duration_reha }}åˆ† ï¼‹ æœ¬ç•ªï¼š{{ progress_info.progress_team.duration_onst }}åˆ† ï¼ 
      åˆè¨ˆï¼š{{ progress_info.total_minutes }}åˆ†
    </p>

    <div class="progress" role="progressbar" aria-label="æ¼”å¥é€²è¡ŒçŠ¶æ³" style="height: 26px;">
      <div class="progress-bar {{ progress_info.bar_class }}"
          id="liveProgressBar"
          data-start="{{ progress_info.start_reha|date:'Y-m-d H:i:s' }}"
          data-end="{{ progress_info.end|date:'Y-m-d H:i:s' }}"
          style="width: {{ progress_info.progress|floatformat:0 }}%;">
        <span id="liveProgressText">{{ progress_info.progress|floatformat:0 }}%</span>
      </div>
    </div>
    <div id="remaining-time" class="text-center mt-1" style="font-weight:600;"></div>
  </div>
</div>

<h2 class="section-title">å‡ºæ¼”è€…ãƒªã‚¹ãƒˆ</h2>

{% for team in team_list %}
  <div class="card mb-4">
    <a href="{% url 'website_app:team_detail_pub' team.id %}" class="card-link">
      <div class="team-card shadow-sm">
        {% if team.file_artpic %}
          <img src="{{ team.file_artpic.url }}" alt="{{ team.team_name }}">

          <div class="team-overlay">
            <h5>{{ team.team_name }}</h5>
          </div>
        {% else %}
          <!-- ç”»åƒãŒãªã„ã¨ãã®è‡ªå‹•ä»£æ›¿ -->
          <div class="p-4 bg-secondary text-white">
            <h5 class="m-0">{{ team.team_name }}</h5>
          </div>
        {% endif %}
      </div>
    </a>

    <div class="card-body">
      <h5 class="card-title">About {{ team.team_name }}</h5>
      <p class="card-text">{{ team.team_desc }}</p>

      <h6 class="mt-3">Appears at</h6>
      <p class="card-text">{{ team.onstage_time }}</p>

      {% if team.team_belong %}
        <p class="card-text"><small class="text-muted">from {{ team.team_belong }}</small></p>
      {% endif %}
    </div>

  </div>
{% endfor %}



<!-- ======== è‡ªå‹•æ›´æ–°ï¼ˆç”»é¢ã‚’æºã‚‰ã•ãªã„ï¼‰ ======== -->
<script>
  setInterval(() => {
    fetch(window.location.href, { cache: "no-store" })
      .then(res => res.text())
      .then(html => {
        document.body.innerHTML = new DOMParser()
          .parseFromString(html, "text/html")
          .querySelector("body").innerHTML;
      });
  }, 10000);


  // Django ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹çµ‚äº†æ™‚åˆ»ï¼ˆISO å½¢å¼ã«ã™ã‚‹ã®ãŒå®‰å…¨ï¼‰
  const endTime = new Date("{{ progress_info.end | date:'Y-m-d H:i:s' }}");

  function updateRemainingTime() {
    const now = new Date();
    const diffMs = endTime - now;
    const diffSec = Math.floor(diffMs / 1000);

    const display = document.getElementById("remaining-time");

    if (diffSec <= 0) {
      display.textContent = "";
      return;
    }

    // æ™‚é–“ãƒ»åˆ†ãƒ»ç§’ã«æˆå½¢ï¼ˆè¦‹ã‚„ã™ã•ã®ãŸã‚ï¼‰
    const h = Math.floor(diffSec / 3600);
    const m = Math.floor((diffSec % 3600) / 60);
    const s = diffSec % 60;

    let formatted = "";
    if (h > 0) formatted += h + "æ™‚é–“ ";
    if (m > 0) formatted += m + "åˆ† ";
    formatted += s + "ç§’";

    display.textContent = "çµ‚äº†ã¾ã§ " + formatted;
  }

  // åˆå›å®Ÿè¡Œ
  updateRemainingTime();

  // 1ç§’ã”ã¨ã«æ›´æ–°
  setInterval(updateRemainingTime, 1500);

  function updateProgress() {
    const bar = document.getElementById("liveProgressBar");
    const text = document.getElementById("liveProgressText");
    const remainText = document.getElementById("remainingTimeText");
    if (!bar) return;

    const start = new Date(bar.dataset.start).getTime();
    const end = new Date(bar.dataset.end).getTime();
    const now = Date.now();

    const total = end - start;
    const passed = now - start;
    let ratio = (passed / total) * 100;

    if (ratio < 0) ratio = 0;
    if (ratio > 100) ratio = 100;

    bar.style.width = ratio.toFixed(0) + "%";
    text.textContent = ratio.toFixed(0) + "%";

    // æ®‹ã‚Šç§’æ•°
    const remainingSec = Math.max(0, Math.floor((end - now) / 1000));
    const min = Math.floor(remainingSec / 60);
    const sec = remainingSec % 60;
    remainText.textContent = `çµ‚äº†ã¾ã§ï¼š${min}åˆ†${sec}ç§’`;

    // çµ‚äº†ã—ãŸã‚‰ç‚¹æ»… + èµ¤è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
    if (ratio >= 100) {
      bar.classList.add("progress-bar-striped", "bg-danger");
      bar.classList.toggle("active-blink");
    }
  }

  // 1ç§’ã”ã¨ã«æ›´æ–°
  setInterval(updateProgress, 1500);
  updateProgress(); // åˆå›å³å®Ÿè¡Œ
</script>

{% endblock %}