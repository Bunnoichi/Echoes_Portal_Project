{% extends 'base/echoes_base.html' %}
{% block title %}ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸{% endblock %}
{% block body %}

<h2 class="mb-3">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</h2>

<div class="container-fluid py-3">

  {# --- å…¨ä½“å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ --- #}
  <div class="alert alert-primary shadow-sm mb-4" role="alert">
    <h5 class="mb-1 fw-bold">ğŸ“¢ å…¨ä½“ã‚¢ãƒŠã‚¦ãƒ³ã‚¹</h5>
    <div class="mb-2">{{ report.repo_public.repo_cont|linebreaksbr }}</div>

    <div class="small text-muted">
      æŠ•ç¨¿æ—¥ï¼š{{ report.repo_public.created_at|date:"Y-m-d H:i" }} / 
      ç™ºè¨€è€…ï¼š{{ report.repo_public.repo_pter }}
    </div>

  </div>

  {# --- ã‚¹ã‚¿ãƒƒãƒ•é™å®š --- #}
  {% if user.is_authenticated %}
    <div class="alert alert-warning shadow-sm mb-4" role="alert">
      <h5 class="mb-1 fw-bold">ğŸ›  ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘é€£çµ¡</h5>
      <div class="mb-2">{{ report.repo_staff.repo_cont|linebreaksbr }}</div>

      <div class="small text-muted">
        æŠ•ç¨¿æ—¥ï¼š{{ report.repo_staff.created_at|date:"Y-m-d H:i" }} / 
        ç™ºè¨€è€…ï¼š{{ report.repo_staff.repo_pter }}
      </div>
    </div>

    {# --- Tweet ç”¨é€£çµ¡ --- #}
    <div class="alert alert-secondary shadow-sm" role="alert">
      <h6 class="mb-1 fw-bold">ğŸ¦ ã‚¹ã‚¿ãƒƒãƒ•ã¤ã¶ã‚„ã ğŸ™„</h6>
      <div class="mb-2">{{ report.repo_tweet.repo_cont|linebreaksbr }}</div>

      <div class="small text-muted">
        æŠ•ç¨¿æ—¥ï¼š{{ report.repo_tweet.created_at|date:"Y-m-d H:i" }} / 
        ç™ºè¨€è€…ï¼š{{ report.repo_tweet.repo_pter }}
      </div>
    </div>
  {% endif %}

</div>


<p class="mb-4">æ›´æ–°æ™‚åˆ»ï¼š<strong>{{ now|date:"Y-m-d H:i:s" }}</strong></p>

<h3 class="mt-4">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸çŠ¶æ³</h3>
<div class="card mb-4">
  <div class="card-body">
    <h4 class="card-title">{{ progress_info.progress_team.team_name }}</h4>
    <p class="card-text">{{ progress_info.progress_team.team_desc }}</p>
    <p class="card-text">
      ãƒªãƒé–‹å§‹ï¼š{{ progress_info.start_reha|date:"H:i" }} ã€œ 
      æœ¬ç•ªï¼š{{ progress_info.progress_team.onstage_time|date:"H:i" }} ã€œ 
      {{ progress_info.end|date:"H:i" }}<br>
      ãƒªãƒï¼š{{ progress_info.progress_team.duration_reha }}åˆ† ï¼‹ æœ¬ç•ªï¼š{{ progress_info.progress_team.duration_onst }}åˆ† ï¼ 
      åˆè¨ˆï¼š{{ progress_info.total_minutes }}åˆ†
    </p>

    <div class="progress" role="progressbar" aria-label="æ¼”å¥é€²è¡ŒçŠ¶æ³" style="height: 26px;">
      <div class="progress-bar {{ progress_info.bar_class }}"
          id="liveProgressBar"
          data-start="{{ progress_info.start_reha|date:'Y-m-d H:i:s' }}"
          data-end="{{ progress_info.end|date:'Y-m-d H:i:s' }}"
          style="width: {{ progress_info.progress|floatformat:0 }}%;">
        <span id="liveProgressText">{{ progress_info.progress|floatformat:0 }}%</span>
      </div>
    </div>
    <div id="remaining-time" class="text-center mt-1" style="font-weight:600;"></div>

  </div>
</div>

<h3 class="mb-3">å„å ´é¢ã®å—ä»˜çŠ¶æ³</h3>

<!-- ======== èˆå° ======== -->
<div class="card mb-4">
  <div class="card-header bg-danger text-white stage-header">ã‚ªãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>æ®µéš</th><th>å›£ä½“å</th><th>å®šåˆ»</th><th>åˆ°ç€</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>ç¾åœ¨</th><td>{{ onstage_now.team_name }}</td><td>{{ onstage_now.onstage_time }}</td><td>{% if onstage_now.onstage_time_acc %}âœ…{% endif %}</td>
        </tr>
        <tr><th>æ¬¡</th><td>{{ onstage_pos.team_name }}</td><td>{{ onstage_pos.onstage_time }}</td><td>{% if onstage_pos.onstage_time_acc %}âœ…{% endif %}</td></tr>
        <tr><th>æ¬¡ã€…</th><td>{{ onstage_pos2.team_name }}</td><td>{{ onstage_pos2.onstage_time }}</td><td>{% if onstage_pos2.onstage_time_acc %}âœ…{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ======== å‰å®¤ ======== -->
<div class="card mb-4">
  <div class="card-header bg-success text-white stage-header">å‰å®¤</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>æ®µéš</th><th>å›£ä½“å</th><th>å®šåˆ»</th><th>åˆ°ç€</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>ç¾åœ¨</th><td>{{ checkin2_now.team_name }}</td><td>{{ checkin2_now.checkin_pretime_1 }}</td><td>{% if checkin2_now.checkin_postime_1 %}âœ…{% endif %}</td>
        </tr>
        <tr><th>æ¬¡</th><td>{{ checkin2_pos.team_name }}</td><td>{{ checkin2_pos.checkin_pretime_2 }}</td><td>{% if checkin2_pos.checkin_postime_1 %}âœ…{% endif %}</td></tr>
        <tr><th>æ¬¡ã€…</th><td>{{ checkin2_pos2.team_name }}</td><td>{{ checkin2_pos2.checkin_pretime_2 }}</td><td>{% if checkin2_pos2.checkin_postime_1 %}âœ…{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ======== å—ä»˜ ======== -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white stage-header">å—ä»˜</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>æ®µéš</th><th>å›£ä½“å</th><th>å®šåˆ»</th><th>åˆ°ç€</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>ç¾åœ¨</th><td>{{ checkin1_now.team_name }}</td><td>{{ checkin1_now.checkin_pretime_1 }}</td><td>{% if checkin1_now.checkin_postime_1 %}âœ…{% endif %}</td>
        </tr>
        <tr><th>æ¬¡</th><td>{{ checkin1_pos.team_name }}</td><td>{{ checkin1_pos.checkin_pretime_1 }}</td><td>{% if checkin1_pos.checkin_postime_1 %}âœ…{% endif %}</td></tr>
        <tr><th>æ¬¡ã€…</th><td>{{ checkin1_pos2.team_name }}</td><td>{{ checkin1_pos2.checkin_pretime_1 }}</td><td>{% if checkin1_pos2.checkin_postime_1 %}âœ…{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>



<!-- ======== è‡ªå‹•æ›´æ–°ï¼ˆç”»é¢ã‚’æºã‚‰ã•ãªã„ï¼‰ ======== -->
<script>
  setInterval(() => {
    fetch(window.location.href, { cache: "no-store" })
      .then(res => res.text())
      .then(html => {
        document.body.innerHTML = new DOMParser()
          .parseFromString(html, "text/html")
          .querySelector("body").innerHTML;
      });
  }, 10000);


  // Django ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹çµ‚äº†æ™‚åˆ»ï¼ˆISO å½¢å¼ã«ã™ã‚‹ã®ãŒå®‰å…¨ï¼‰
  const endTime = new Date("{{ progress_info.end | date:'Y-m-d H:i:s' }}");

  function updateRemainingTime() {
    const now = new Date();
    const diffMs = endTime - now;
    const diffSec = Math.floor(diffMs / 1000);

    const display = document.getElementById("remaining-time");

    if (diffSec <= 0) {
      display.textContent = "";
      return;
    }

    // æ™‚é–“ãƒ»åˆ†ãƒ»ç§’ã«æˆå½¢ï¼ˆè¦‹ã‚„ã™ã•ã®ãŸã‚ï¼‰
    const h = Math.floor(diffSec / 3600);
    const m = Math.floor((diffSec % 3600) / 60);
    const s = diffSec % 60;

    let formatted = "";
    if (h > 0) formatted += h + "æ™‚é–“ ";
    if (m > 0) formatted += m + "åˆ† ";
    formatted += s + "ç§’";

    display.textContent = "çµ‚äº†ã¾ã§ " + formatted;
  }

  // åˆå›å®Ÿè¡Œ
  updateRemainingTime();

  // 1ç§’ã”ã¨ã«æ›´æ–°
  setInterval(updateRemainingTime, 1500);

  function updateProgress() {
    const bar = document.getElementById("liveProgressBar");
    const text = document.getElementById("liveProgressText");
    const remainText = document.getElementById("remainingTimeText");
    if (!bar) return;

    const start = new Date(bar.dataset.start).getTime();
    const end = new Date(bar.dataset.end).getTime();
    const now = Date.now();

    const total = end - start;
    const passed = now - start;
    let ratio = (passed / total) * 100;

    if (ratio < 0) ratio = 0;
    if (ratio > 100) ratio = 100;

    bar.style.width = ratio.toFixed(0) + "%";
    text.textContent = ratio.toFixed(0) + "%";

    // æ®‹ã‚Šç§’æ•°
    const remainingSec = Math.max(0, Math.floor((end - now) / 1000));
    const min = Math.floor(remainingSec / 60);
    const sec = remainingSec % 60;
    remainText.textContent = `çµ‚äº†ã¾ã§ï¼š${min}åˆ†${sec}ç§’`;

    // çµ‚äº†ã—ãŸã‚‰ç‚¹æ»… + èµ¤è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
    if (ratio >= 100) {
      bar.classList.add("progress-bar-striped", "bg-danger");
      bar.classList.toggle("active-blink");
    }
  }

  // 1ç§’ã”ã¨ã«æ›´æ–°
  setInterval(updateProgress, 1500);
  updateProgress(); // åˆå›å³å®Ÿè¡Œ
</script>

{% endblock %}