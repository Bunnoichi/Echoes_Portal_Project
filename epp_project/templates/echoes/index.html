{% extends 'base/echoes_base.html' %}
{% block title %}トップページ{% endblock %}
{% block body %}

<h2 class="mb-3">トップページ</h2>

{% comment %} 全体表示メッセージ {% endcomment %}
<div>
  {{ report.repo_public.repo_cont }}
  {{ report.repo_public.created_at }}
  {{ report.repo_public.repo_publicity }}
  {{ report.repo_public.repo_tweet }}
</div>
{% comment %} スタッフ限定メッセージ {% endcomment %}
{% if user.is_authenticated %}
  <div>
    {{ report.repo_staff.repo_cont }}
    {{ report.repo_staff.created_at }}
    {{ report.repo_staff.repo_publicity }}
    {{ report.repo_staff.repo_tweet }}<br>
    {% comment %} tweet {% endcomment %}
    {{ report.repo_tweet.repo_cont }}
    {{ report.repo_tweet.created_at }}
    {{ report.repo_tweet.repo_publicity }}
    {{ report.repo_tweet.repo_tweet }}
  </div>
{% endif %}

<p class="mb-4">更新時刻：<strong>{{ now|date:"Y-m-d H:i:s" }}</strong></p>

<h3 class="mt-4">現在のステージ状況</h3>
<div class="card mb-4">
  <div class="card-body">
    <h4 class="card-title">{{ progress_info.progress_team.team_name }}</h4>
    <p class="card-text">{{ progress_info.progress_team.team_desc }}</p>
    <p class="card-text">
      リハ開始：{{ progress_info.start_reha|date:"H:i" }} 〜 
      本番：{{ progress_info.progress_team.onstage_time|date:"H:i" }} 〜 
      {{ progress_info.end|date:"H:i" }}<br>
      リハ：{{ progress_info.progress_team.duration_reha }}分 ＋ 本番：{{ progress_info.progress_team.duration_onst }}分 ＝ 
      合計：{{ progress_info.total_minutes }}分
    </p>

    <div class="progress" role="progressbar" aria-label="演奏進行状況" style="height: 26px;">
      <div class="progress-bar {{ progress_info.bar_class }}"
          id="liveProgressBar"
          data-start="{{ progress_info.start_reha|date:'Y-m-d H:i:s' }}"
          data-end="{{ progress_info.end|date:'Y-m-d H:i:s' }}"
          style="width: {{ progress_info.progress|floatformat:0 }}%;">
        <span id="liveProgressText">{{ progress_info.progress|floatformat:0 }}%</span>
      </div>
    </div>
    <div id="remaining-time" class="text-center mt-1" style="font-weight:600;"></div>

  </div>
</div>

<h3 class="mb-3">各場面の受付状況</h3>

<!-- ======== 受付 ======== -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white stage-header">受付</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>段階</th><th>団体名</th><th>定刻</th><th>到着</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>現在</th><td>{{ checkin1_now.team_name }}</td><td>{{ checkin1_now.checkin_pretime_1 }}</td><td>{% if checkin1_now.checkin_postime_1 %}✅{% endif %}</td>
        </tr>
        <tr><th>次</th><td>{{ checkin1_pos.team_name }}</td><td>{{ checkin1_pos.checkin_pretime_1 }}</td><td>{% if checkin1_pos.checkin_postime_1 %}✅{% endif %}</td></tr>
        <tr><th>次々</th><td>{{ checkin1_pos2.team_name }}</td><td>{{ checkin1_pos2.checkin_pretime_1 }}</td><td>{% if checkin1_pos2.checkin_postime_1 %}✅{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ======== 前室 ======== -->
<div class="card mb-4">
  <div class="card-header bg-success text-white stage-header">前室</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>段階</th><th>団体名</th><th>定刻</th><th>到着</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>現在</th><td>{{ checkin2_now.team_name }}</td><td>{{ checkin2_now.checkin_pretime_1 }}</td><td>{% if checkin2_now.checkin_postime_1 %}✅{% endif %}</td>
        </tr>
        <tr><th>次</th><td>{{ checkin2_pos.team_name }}</td><td>{{ checkin2_pos.checkin_pretime_2 }}</td><td>{% if checkin2_pos.checkin_postime_1 %}✅{% endif %}</td></tr>
        <tr><th>次々</th><td>{{ checkin2_pos2.team_name }}</td><td>{{ checkin2_pos2.checkin_pretime_2 }}</td><td>{% if checkin2_pos2.checkin_postime_1 %}✅{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ======== 舞台 ======== -->
<div class="card mb-4">
  <div class="card-header bg-danger text-white stage-header">オンステージ</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr><th>段階</th><th>団体名</th><th>定刻</th><th>到着</th></tr>
      </thead>
      <tbody>
        <tr class="status-now">
          <th>現在</th><td>{{ onstage_now.team_name }}</td><td>{{ onstage_now.onstage_time }}</td><td>{% if onstage_now.onstage_time_acc %}✅{% endif %}</td>
        </tr>
        <tr><th>次</th><td>{{ onstage_pos.team_name }}</td><td>{{ onstage_pos.onstage_time }}</td><td>{% if onstage_pos.onstage_time_acc %}✅{% endif %}</td></tr>
        <tr><th>次々</th><td>{{ onstage_pos2.team_name }}</td><td>{{ onstage_pos2.onstage_time }}</td><td>{% if onstage_pos2.onstage_time_acc %}✅{% endif %}</td></tr>
      </tbody>
    </table>
  </div>
</div>



<!-- ======== 自動更新（画面を揺らさない） ======== -->
<script>
  setInterval(() => {
    fetch(window.location.href, { cache: "no-store" })
      .then(res => res.text())
      .then(html => {
        document.body.innerHTML = new DOMParser()
          .parseFromString(html, "text/html")
          .querySelector("body").innerHTML;
      });
  }, 10000);


  // Django から渡される終了時刻（ISO 形式にするのが安全）
  const endTime = new Date("{{ progress_info.end | date:'Y-m-d H:i:s' }}");

  function updateRemainingTime() {
    const now = new Date();
    const diffMs = endTime - now;
    const diffSec = Math.floor(diffMs / 1000);

    const display = document.getElementById("remaining-time");

    if (diffSec <= 0) {
      display.textContent = "";
      return;
    }

    // 時間・分・秒に成形（見やすさのため）
    const h = Math.floor(diffSec / 3600);
    const m = Math.floor((diffSec % 3600) / 60);
    const s = diffSec % 60;

    let formatted = "";
    if (h > 0) formatted += h + "時間 ";
    if (m > 0) formatted += m + "分 ";
    formatted += s + "秒";

    display.textContent = "終了まで " + formatted;
  }

  // 初回実行
  updateRemainingTime();

  // 1秒ごとに更新
  setInterval(updateRemainingTime, 1500);

  function updateProgress() {
    const bar = document.getElementById("liveProgressBar");
    const text = document.getElementById("liveProgressText");
    const remainText = document.getElementById("remainingTimeText");
    if (!bar) return;

    const start = new Date(bar.dataset.start).getTime();
    const end = new Date(bar.dataset.end).getTime();
    const now = Date.now();

    const total = end - start;
    const passed = now - start;
    let ratio = (passed / total) * 100;

    if (ratio < 0) ratio = 0;
    if (ratio > 100) ratio = 100;

    bar.style.width = ratio.toFixed(0) + "%";
    text.textContent = ratio.toFixed(0) + "%";

    // 残り秒数
    const remainingSec = Math.max(0, Math.floor((end - now) / 1000));
    const min = Math.floor(remainingSec / 60);
    const sec = remainingSec % 60;
    remainText.textContent = `終了まで：${min}分${sec}秒`;

    // 終了したら点滅 + 赤表示（任意）
    if (ratio >= 100) {
      bar.classList.add("progress-bar-striped", "bg-danger");
      bar.classList.toggle("active-blink");
    }
  }

  // 1秒ごとに更新
  setInterval(updateProgress, 1500);
  updateProgress(); // 初回即実行
</script>

{% endblock %}